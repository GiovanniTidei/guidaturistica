<!-- <!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Guida Turistica</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <style>
      .audio-btn {
        background: #000;
        color: #fff;
        border: none;
        border-radius: 2rem;
        padding: 0.5rem 2rem;
        font-weight: 500;
        margin-bottom: 1rem;
        transition: background 0.2s, color 0.2s;
      }
      .audio-btn:hover, .audio-btn:focus {
        background: #222 !important;
        color: #fff !important;
        outline: none !important;
      }
    </style>
</head>
<body>
    <div class="container py-5" id="main-content">
        <div class="d-flex justify-content-center align-items-center" style="height: 100vh;" id="loader">
  <div class="spinner-border text-dark" role="status" style="width: 4rem; height: 4rem;">
    <span class="visually-hidden">Caricamento...</span>
  </div>
</div>

    </div>
    <script>
  // URL del tuo Apps Script pubblicato come Web App
  const DATI_SITI = 'https://script.google.com/macros/s/AKfycbz_vCmqTW28sEUDcEj-kg48TBAKpDt_cgmfxRyKDy8P31f1-AD2JfxX__bniSnCBz0P/exec';
  const DATI_SIMULAZIONI = 'https://script.google.com/macros/s/AKfycbx3vz33LsWKl9OuhFbtIQbzAm3dPdU8aZPGoWeUFjioT93oJDNZUtowCf_XAMOhofnd/exec';
 const DATI_MUSEI = 'https://script.google.com/macros/s/AKfycbytsQmB3X8E6HkvmI7ZlBbbbOMiiRwm_PxznEUXv5f5ZVonAHLmPdje1B-2MHf857aa/exec';
  let datiSiti = [];
  let datiMusei = [];
  let datiSimulazioni = [];

  // Karaoke highlighting variables
  let currentWordIndex = 0;
  let words = [];
  let highlightInterval;
  let synth = window.speechSynthesis;
  let utterance;
  let selectedVoice = null;

  // Stato della vista: 'home', 'siti', 'musei', 'simulazioni'
  let currentView = 'home';

  // Carica i dati dei siti da Apps Script
  fetch(DATI_SITI)
    .then(r => r.json())
    .then(data => {
      // Adatta i dati al formato atteso dal frontend
      datiSiti = data.map(row => ({
        regione: row['Regione'],
        nome: row['Nome sito'],
        descrizione: row['Descrizione']
      }));
      mostraHome();
    })
    .catch(() => {
      document.getElementById('main-content').innerHTML = '<div class="alert alert-danger">Errore nel caricamento dei dati dal foglio Google.</div>';
    });

    fetch(DATI_MUSEI)
  .then(r => r.json())
  .then(data => {
    datiMusei = data.map(row => ({
      regione: row['Regione'],
      nome: row['Nome sito'],
      descrizione: row['Descrizione']
    }));
  });

fetch(DATI_SIMULAZIONI)
  .then(r => r.json())
  .then(data => {
    console.log(data); // ðŸ” mostra cosa ricevi dal foglio
    datiSimulazioni = data.map(row => ({
      regione: row['Regione'],
      nome: row['Nome sito'],
      descrizione: row['Descrizione'],
      descrizione_fr: row['Descrizione_fr']
    }));
  });

  // Voce italiana per audio
  function setVoice() {
    const voices = synth.getVoices();
    selectedVoice = voices.find(v => v.lang.startsWith('it') && v.name.toLowerCase().includes('google'));
    if (!selectedVoice) {
      selectedVoice = voices.find(v => v.lang.startsWith('it'));
    }
  }
  if (typeof speechSynthesis !== "undefined") {
    speechSynthesis.onvoiceschanged = setVoice;
    setVoice();
  }

  function wrapWordsInSpans(text) {
    return text.split(/(\s+)/).map((word, index) => {
      if (word.trim()) {
        return `<span class="word" data-index="${Math.floor(index/2)}">${word}</span>`;
      }
      return word;
    }).join('');
  }

  function highlightReadText(currentIndex) {
    document.querySelectorAll('.word').forEach((word, index) => {
      const wordIndex = parseInt(word.dataset.index);
      if (wordIndex < currentIndex) {
        word.classList.remove('current');
        word.classList.add('read');
      } else if (wordIndex === currentIndex) {
        word.classList.remove('read');
        word.classList.add('current');
        word.scrollIntoView({ behavior: 'smooth', block: 'center', inline: 'center' });
      } else {
        word.classList.remove('read', 'current');
      }
    });
  }

  function startHighlighting() {
    const wordsPerMinute = 150;
    const millisecondsPerWord = (60 / wordsPerMinute) * 1000;
    highlightInterval = setInterval(() => {
      if (currentWordIndex < words.length) {
        highlightReadText(currentWordIndex);
        currentWordIndex++;
      } else {
        stopHighlighting();
      }
    }, millisecondsPerWord);
  }

  function stopHighlighting() {
    if (highlightInterval) {
      clearInterval(highlightInterval);
      highlightInterval = null;
    }
    document.querySelectorAll('.word').forEach(word => {
      word.classList.remove('read', 'current');
    });
    currentWordIndex = 0;
  }

  // Stop audio su qualsiasi click, tranne Play/Stop
  document.addEventListener('click', function(e) {
    if (
      e.target.id === 'playBtn' ||
      e.target.id === 'stopBtn'
    ) return;
    stopAudio();
  }, true);

  // Play sempre funzionante e sempre riparte dall'inizio
  function playAudio(textOverride) {
    stopAudio();
    let text = "";
    if (typeof textOverride === "string" && textOverride.trim().length > 0) {
      text = textOverride.trim();
      words = text.split(/\s+/);
    } else if (words && words.length > 0) {
      text = words.join(' ');
    } else {
      let descr = document.getElementById('descrizione') || document.getElementById('descrizioneMuseo');
      if (descr) {
        text = descr.innerText || descr.textContent || "";
        words = text.trim().split(/\s+/);
      }
      if (!text.trim()) return;
    }
    utterance = new SpeechSynthesisUtterance(text);
    utterance.lang = "it-IT";
    if(selectedVoice) utterance.voice = selectedVoice;
    utterance.rate = 0.98; // piÃ¹ naturale e meno veloce
    utterance.pitch = 1;   // tono naturale
    utterance.volume = 1;
    currentWordIndex = 0;
    startHighlighting();
    utterance.onend = function() { stopHighlighting(); };
    utterance.onerror = function() { stopHighlighting(); };
    synth.speak(utterance);
  }
  function stopAudio() {
    if(synth.speaking) synth.cancel();
    stopHighlighting();
  }

  document.addEventListener('click', function(e) {
    if (
      e.target.id === 'playBtn' ||
      e.target.id === 'stopBtn'
    ) return;
    stopAudio();
  });

  // Home con un solo pulsante nero per ogni sezione
  function mostraHome() {
    currentView = 'home';
    document.getElementById('main-content').innerHTML = `
      <h1 class="mb-4 text-center">Guida Turistica</h1>
      <div class="d-flex flex-column align-items-center" style="max-width: 400px; margin: 0 auto;">
        <button class="audio-btn main-link w-100 mb-3" data-type="siti">Siti</button>
        <div class="w-100 d-flex align-items-center justify-content-center my-2">
          <hr class="flex-grow-1" style="border-top: 2px solid #bbb; margin: 0 1rem;">
        </div>
        <button class="audio-btn main-link w-100 mb-3" data-type="musei">Musei</button>
        <div class="w-100 d-flex align-items-center justify-content-center my-2">
          <hr class="flex-grow-1" style="border-top: 2px solid #bbb; margin: 0 1rem;">
        </div>
        <button class="audio-btn main-link w-100" data-type="simulazioni">Simulazioni</button>
      </div>
    `;
    document.querySelectorAll('.main-link').forEach(el => {
      el.addEventListener('click', function() {
        if (el.dataset.type === 'siti') mostraRegioni('siti');
        if (el.dataset.type === 'musei') mostraRegioni('musei');
        if (el.dataset.type === 'simulazioni') mostraRegioni('simulazioni');
      });
    });
  }

  // Mostra le regioni per la categoria scelta
  function mostraRegioni(tipo) {
    currentView = tipo;
    let dati, titolo;
    if (tipo === 'siti') {
      dati = datiSiti;
      titolo = 'Siti';
    } else if (tipo === 'musei') {
      dati = datiMusei;
      titolo = 'Musei';
    } else {
      dati = datiSimulazioni;
      titolo = 'Simulazioni';
    }
    document.getElementById('main-content').innerHTML = `
      <button class="modern-back mb-3" id="backHome" type="button">
        <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7"/></svg>
        Torna alla home
      </button>
      <h2 class="mb-3">${titolo} per regione</h2>
      <ul class="list-group" id="regioni-list">
        ${[...new Set(dati.map(s => s.regione))].sort((a, b) => a.localeCompare(b, 'it')).map(regione =>
          `<li class="list-group-item region-link" data-region="${regione}">${regione}</li>`
        ).join('')}
      </ul>
    `;
    document.getElementById('backHome').onclick = mostraHome;
    document.querySelectorAll('.region-link').forEach(el => {
      el.addEventListener('click', function() {
        if (tipo === 'siti') mostraSiti(el.dataset.region);
        if (tipo === 'musei') mostraMusei(el.dataset.region);
        if (tipo === 'simulazioni') mostraSimulazioni(el.dataset.region);
      });
    });
  }

  // Mostra i siti di una regione
  function mostraSiti(region) {
    const siti = datiSiti.filter(s => s.regione === region);
    document.getElementById('main-content').innerHTML = `
      <button class="modern-back mb-3" id="backRegioni" type="button">
        <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7"/></svg>
        Torna alle regioni
      </button>
      <h2 class="mb-3">${region}</h2>
      <ul class="list-group mb-3">
        ${siti.map((sito, idx) => `<li class="list-group-item site-link" data-site="${idx}">${sito.nome}</li>`).join('')}
      </ul>
    `;
    document.getElementById('backRegioni').onclick = () => mostraRegioni('siti');
    document.querySelectorAll('.site-link').forEach((el, idx) => {
      el.addEventListener('click', function() {
        mostraDettaglioSito(region, idx);
      });
    });
  }

  // Mostra i musei di una regione
  function mostraMusei(region) {
    const musei = datiMusei.filter(s => s.regione === region);
    document.getElementById('main-content').innerHTML = `
      <button class="modern-back mb-3" id="backRegioni" type="button">
        <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7"/></svg>
        Torna alle regioni
      </button>
      <h2 class="mb-3">${region}</h2>
      <ul class="list-group mb-3">
        ${musei.map((museo, idx) => `<li class="list-group-item museo-link" data-museo="${idx}">${museo.nome}</li>`).join('')}
      </ul>
    `;
    window.scrollTo({ top: 0, behavior: 'smooth' });

    document.getElementById('backRegioni').onclick = () => mostraRegioni('musei');
    document.querySelectorAll('.museo-link').forEach((el, idx) => {
      el.addEventListener('click', function() {
        mostraDettaglioMuseo(region, idx);
      });
    });
  }

  // Mostra le simulazioni di una regione
  function mostraSimulazioni(region) {
    const simulazioni = datiSimulazioni.filter(s => s.regione === region);
    document.getElementById('main-content').innerHTML = `
      <button class="modern-back mb-3" id="backRegioni" type="button">
        <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7"/></svg>
        Torna alle regioni
      </button>
      <h2 class="mb-3">${region}</h2>
      <ul class="list-group mb-3">
        ${simulazioni.map((sim, idx) => `<li class="list-group-item simulazione-link" data-simulazione="${idx}">${sim.nome}</li>`).join('')}
      </ul>
    `;
    document.getElementById('backRegioni').onclick = () => mostraRegioni('simulazioni');
    document.querySelectorAll('.simulazione-link').forEach((el, idx) => {
      el.addEventListener('click', function() {
        mostraDettaglioSimulazione(region, idx);
      });
    });
  }

  // Dettaglio sito con audio
  function mostraDettaglioSito(region, idx) {
    const sitiRegione = datiSiti.filter(s => s.regione === region);
    const sito = sitiRegione[idx];
    // FIX: Rimuovi eventuali caratteri speciali che possono bloccare TTS
    const descrizioneTesto = (sito.descrizione || "").replace(/\r?\n/g, " ").replace(/\s+/g, " ").trim();
    const wrappedText = wrapWordsInSpans(sito.descrizione || "");
    document.getElementById('main-content').innerHTML = `
      <button class="modern-back mb-3" id="backSiti" type="button">
        <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7"/></svg>
        Torna ai siti
      </button>
      <h2 class="mb-3">${sito.nome}</h2>
      <button class="audio-btn me-2" id="playBtn">Play</button>
      <button class="audio-btn" id="stopBtn">Stop</button>
      <div id="descrizione">${wrappedText}</div>
    `;
    words = descrizioneTesto.length > 0 ? descrizioneTesto.split(/\s+/) : [];
    document.getElementById('playBtn').addEventListener('click', function(e){
      e.stopPropagation();
      playAudio(descrizioneTesto);
    });
    document.getElementById('stopBtn').addEventListener('click', function(e){
      e.stopPropagation();
      stopAudio();
    });
    document.getElementById('backSiti').onclick = () => mostraSiti(region);
  }

  // Dettaglio museo con audio
  function mostraDettaglioMuseo(region, idx) {
    const museiRegione = datiMusei.filter(s => s.regione === region);
    const museo = museiRegione[idx];
    const wrappedText = wrapWordsInSpans(museo.descrizione || "");
    document.getElementById('main-content').innerHTML = `
      <button class="modern-back mb-3" id="backMusei" type="button">
        <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7"/></svg>
        Torna ai musei
      </button>
      <h2 class="mb-3">${museo.nome}</h2>
      <button class="audio-btn me-2" id="playBtn">Play</button>
      <button class="audio-btn" id="stopBtn">Stop</button>
      <div id="descrizioneMuseo">${wrappedText}</div>
    `;
    words = Array.from(document.querySelectorAll('.word')).map(span => span.textContent.trim());
    document.getElementById('playBtn').addEventListener('click', function(e){
      e.stopPropagation();
      playAudio();
    });
    document.getElementById('stopBtn').addEventListener('click', function(e){
      e.stopPropagation();
      stopAudio();
    });
    document.getElementById('backMusei').onclick = () => mostraMusei(region);
  }

  // Dettaglio simulazione con audio e switch lingua senza auto-play
  function mostraDettaglioSimulazione(region, idx) {
    const simulazioniRegione = datiSimulazioni.filter(s => s.regione === region);
    const simulazione = simulazioniRegione[idx];
    let lingua = 'it'; // default italiano

    function renderSimulazione(lang) {
      const testo = lang === 'fr' ? (simulazione.descrizione_fr || "") : (simulazione.descrizione || "");
      const wrappedText = wrapWordsInSpans(testo);
      document.getElementById('main-content').innerHTML = `
        <button class="modern-back mb-3" id="backSimulazioni" type="button">
          <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7"/></svg>
          Torna alle simulazioni
        </button>
        <h2 class="mb-3">${simulazione.nome}</h2>
        <div class="mb-3">
          <span id="flag-it" style="cursor:pointer;font-size:1.7em;" title="Italiano">ðŸ‡®ðŸ‡¹</span>
          <span id="flag-fr" style="cursor:pointer;font-size:1.7em;margin-left:0.5em;" title="Francese">ðŸ‡«ðŸ‡·</span>
        </div>
        <button class="audio-btn me-2" id="playBtn">Play</button>
        <button class="audio-btn" id="stopBtn">Stop</button>
        <div id="descrizioneSimulazione">${wrappedText}</div>
      `;
      words = Array.from(document.querySelectorAll('.word')).map(span => span.textContent.trim());
      document.getElementById('playBtn').addEventListener('click', function(e){
        e.stopPropagation();
        playAudioSimulazione(lang);
      });
      document.getElementById('stopBtn').addEventListener('click', function(e){
        e.stopPropagation();
        stopAudio();
      });
      document.getElementById('backSimulazioni').onclick = () => mostraSimulazioni(region);
      document.getElementById('flag-it').onclick = () => {
        lingua = 'it';
        renderSimulazione('it');
      };
      document.getElementById('flag-fr').onclick = () => {
        lingua = 'fr';
        renderSimulazione('fr');
      };
    }

    function playAudioSimulazione(lang) {
      stopAudio();
      const text = lang === 'fr'
        ? (simulazione.descrizione_fr || "")
        : (simulazione.descrizione || "");
      words = text.split(/\s+/);
      utterance = new SpeechSynthesisUtterance(text);
      utterance.lang = lang === 'fr' ? "fr-FR" : "it-IT";
      const voices = synth.getVoices();
      let voice = voices.find(v => v.lang.startsWith(lang === 'fr' ? 'fr' : 'it') && v.name.toLowerCase().includes('google'));
      if (!voice) voice = voices.find(v => v.lang.startsWith(lang === 'fr' ? 'fr' : 'it'));
      if (voice) utterance.voice = voice;
      utterance.rate = 0.98; // piÃ¹ naturale e meno veloce
      utterance.pitch = 1;
      utterance.volume = 1;
      currentWordIndex = 0;
      startHighlighting();
      utterance.onend = function() { stopHighlighting(); };
      utterance.onerror = function() { stopHighlighting(); };
      synth.speak(utterance);
    }

    renderSimulazione('it');
  }
    </script>
</body>
</html> -->

<!-- test inglese -->

<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test di Inglese B2</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { padding: 20px 0; background: #f8f9fa; }
        .question-card { margin-bottom: 30px; background: white; }
        .option { cursor: pointer; transition: all 0.3s; padding: 15px; border-radius: 8px; margin: 8px 0; border: 2px solid #dee2e6; }
        .option:hover:not(.disabled) { background: #f8f9fa; transform: translateX(5px); }
        .correct { background: #d4edda !important; border-color: #28a745 !important; }
        .incorrect { background: #f8d7da !important; border-color: #dc3545 !important; }
        .disabled { pointer-events: none; opacity: 0.7; }
        .explanation { margin-top: 15px; padding: 15px; background: #e7f3ff; border-left: 4px solid #0d6efd; display: none; }
        .badge-level { font-size: 0.9rem; }
        .reading-passage { background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px; line-height: 1.8; }
    </style>
</head>
<body>
    <div class="container">
        <div class="text-center mb-5">
            <h1 class="display-4">Test di Inglese B2</h1>
            <p class="lead">Preparazione al concorso - 30 quesiti</p>
            <span class="badge bg-primary badge-level">Livello B2 - Upper Intermediate</span>
        </div>

        <div id="questions-container"></div>

        <div class="text-center mt-4">
            <button class="btn btn-primary btn-lg" onclick="location.reload()">
                <i class="bi bi-arrow-clockwise"></i> Ricarica Test
            </button>
        </div>
    </div>

    <script>
        const questions = [
            {
                type: "phrasal",
                text: "When planning a new event, it is always essential to work ________ the total costs in advance.",
                options: ["away", "under", "in", "out"],
                correct: 3,
                explanation: "Il phrasal verb 'work out' significa 'calcolare' o 'determinare'. Ãˆ comune nel contesto di costi e calcoli finanziari. Altri phrasal verbs come 'work away' (lavorare continuamente) o 'work under' (lavorare sotto qualcuno) non hanno senso in questo contesto."
            },
            {
                type: "reading",
                passage: "Despite the chaos of lockdown, by the end of 2020 overall sales of print books in the UK were up 5% year-on-year, according to industry watchers Nielsen BookScan. More particularly, fiction did extremely well â€“ adult fiction increased 8% in volume terms, with 147 million books sold. So too did children's books, up 7%, to 109 million books. Overall, the British public spent Â£1.8 billion on 202 million print books. Digital sales soared, ebooks growing 16% and audiobook sales 21% year on year.",
                text: "'Soared' in this context means:",
                options: ["stayed the same", "went up quickly", "decreased slightly", "dropped steadily"],
                correct: 1,
                explanation: "'Soared' significa 'salire rapidamente' o 'schizzare in alto'. Nel contesto delle vendite digitali che crescono del 16-21%, indica un aumento rapido e significativo. Ãˆ un verbo forte usato per enfatizzare una crescita importante."
            },
            {
                type: "reading",
                passage: "The long wait is over for students and academics, who return to face-to-face teaching this term, in a place that truly has the benefits of meeting in the real world. The new Marshall Building, which looks out over Lincoln's Inn Fields like a shiny white palazzo, houses some of the finest spaces that any London university has to offer. The project is the latest addition to the London School of Economics' (LSE) impressive stable of recent commissions, which comprise the Centre Building's steel-framed blocks.",
                text: "The Marshall Building is:",
                options: ["London University's new headquarters", "LSE's latest architectural project", "home to LSE's Department of Law", "going to replace the Centre Building"],
                correct: 1,
                explanation: "Il testo afferma chiaramente che 'the project is the latest addition to the London School of Economics' (LSE) impressive stable of recent commissions', quindi Ã¨ l'ultimo progetto architettonico della LSE. Non Ã¨ il quartier generale, nÃ© specificamente per legge, nÃ© sostituisce il Centre Building."
            },
            {
                type: "reading",
                passage: "Parents or teachers of teenagers may find it hard to believe that sarcasm is a sign of a flexible and inventive mind. Yet, that is exactly what psychologists and neuroscientists have been arguing. They have found that sarcasm requires the brain to create numerous connections to arrive at a correct interpretation, requiring more brainpower than literal statements. Although it is often considered juvenile irreverence, sarcasm is actually evidence of maturity â€“ because it takes years for a child's developing brain to fully understand and master it.",
                text: "According to the text, sarcasm:",
                options: ["denotes a lack of respect for people and things", "requires a child's brain to be better understood", "is a sign of intelligence and of a maturing brain", "is evidence that a teenager's brain has not developed yet"],
                correct: 2,
                explanation: "Il testo dice che il sarcasmo 'is actually evidence of maturity' e richiede piÃ¹ potenza cerebrale. Ãˆ un segno di intelligenza e di un cervello che matura, non di mancanza di rispetto o di sviluppo incompleto."
            },
            {
                type: "relative",
                text: "This is the most expensive mobile ______ they had in store. I only buy the best technology at this point.",
                options: ["then", "than", "thus", "that"],
                correct: 3,
                explanation: "'That' Ã¨ il pronome relativo corretto per introdurre una proposizione relativa restrittiva. 'Than' si usa per comparazioni, 'then' per sequenze temporali, 'thus' significa 'quindi'. La struttura Ã¨: superlativo + that + clausola relativa."
            },
            {
                type: "tense",
                text: "When I travel to England next year, I ____________ English for 6 years, so I will be able to speak the language fluently.",
                options: ["will have studied", "study", "have studying", "studies"],
                correct: 0,
                explanation: "Il Future Perfect ('will have studied') indica un'azione che sarÃ  completata prima di un momento futuro. La struttura 'for 6 years' indica durata e richiede questo tempo. Si usa per esprimere un'esperienza completata prima di un punto futuro."
            },
            {
                type: "infinitive",
                text: "My new boss didn't let ____________ on holiday during the emergency at work.",
                options: ["me go", "to go", "me to go", "me going"],
                correct: 0,
                explanation: "Il verbo 'let' Ã¨ seguito dall'oggetto + infinito senza 'to' (bare infinitive). La struttura Ã¨: let + oggetto + verbo base. Altri verbi come 'allow' richiederebbero 'to' (allow me to go), ma 'let' no."
            },
            {
                type: "phrasal",
                text: "You have to ____________ with this issue, so we can go on with the plan.",
                options: ["make", "beat", "solve", "deal"],
                correct: 3,
                explanation: "'Deal with' significa 'occuparsi di' o 'gestire' un problema. Ãˆ il phrasal verb corretto per problemi o questioni. 'Solve' si usa senza preposizione (solve the problem), mentre 'deal with' richiede 'with'."
            },
            {
                type: "gerund",
                text: "____________ the radio helps me improve my receptive skills.",
                options: ["Listen to", "Listening to", "Listened to", "Have listened to"],
                correct: 1,
                explanation: "Quando un verbo Ã¨ soggetto della frase, si usa il gerundio (-ing form). 'Listening to the radio' Ã¨ il soggetto della frase. Il gerundio rende il verbo un sostantivo e puÃ² funzionare come soggetto, oggetto o complemento."
            },
            {
                type: "vocabulary",
                text: "Large cruise ships are usually run with a ____________ of at least 200 people.",
                options: ["crew", "cast", "squad", "gang"],
                correct: 0,
                explanation: "'Crew' Ã¨ il termine specifico per il personale di una nave. 'Cast' si usa per attori, 'squad' per squadre sportive o militari, 'gang' ha connotazione negativa (banda criminale). Ogni contesto ha il suo termine specifico."
            },
            {
                type: "vocabulary",
                text: "Have you ever been ____________ while travelling abroad?",
                options: ["shoplifted", "vandalised", "mugged", "stolen"],
                correct: 2,
                explanation: "'Mugged' significa essere rapinato per strada con violenza. 'Shoplifted' Ã¨ rubare nei negozi (non si usa con persone come soggetto passivo), 'vandalised' Ã¨ danneggiare proprietÃ , 'stolen' non si usa in forma passiva con persone."
            },
            {
                type: "tense",
                text: "The old woman _______________ the burglar and scared him off.",
                options: ["shouted at", "will shout at", "whispered", "had whispered"],
                correct: 0,
                explanation: "Il Past Simple 'shouted at' Ã¨ corretto perchÃ© descrive due azioni passate in sequenza. 'Scared him off' (lo spaventÃ² via) Ã¨ anch'esso Past Simple, indicando che le due azioni sono avvenute nello stesso momento nel passato."
            },
            {
                type: "verb-pattern",
                text: "She doesn't ____________ looking after the baby for us next weekend, does she?",
                options: ["hope", "mind", "object", "stand"],
                correct: 1,
                explanation: "'Mind' + gerundio significa 'dispiacersi di fare qualcosa'. Si usa spesso in domande o frasi negative: 'Do you mind...?' / 'I don't mind...'. 'Object to' richiederebbe la preposizione 'to', 'hope' non si usa in questo pattern."
            },
            {
                type: "correlative",
                text: "Sarah could attend _________________ the morning meeting nor the afternoon session today.",
                options: ["neither", "both", "either", "nor"],
                correct: 0,
                explanation: "'Neither...nor' Ã¨ una struttura correlativa che significa 'nÃ©...nÃ©'. Si usa per negare entrambe le opzioni. 'Either...or' sarebbe per situazioni affermative. La struttura richiede 'neither' all'inizio quando si nega."
            },
            {
                type: "vocabulary",
                text: "I called him to ____________ him about the train strike.",
                options: ["warn", "say", "speak", "advertise"],
                correct: 0,
                explanation: "'Warn someone about something' significa avvisare qualcuno di un pericolo o problema. 'Say' e 'speak' non si usano con questa struttura (say something to someone / speak to someone about something). 'Advertise' significa fare pubblicitÃ ."
            },
            {
                type: "conditional",
                text: "If I ____________ more time, I would have finished the project yesterday.",
                options: ["have had", "had", "had had", "would have"],
                correct: 2,
                explanation: "Il Third Conditional (if + past perfect, would have + past participle) esprime situazioni ipotetiche nel passato. 'Had had' Ã¨ il Past Perfect di 'have', necessario per indicare che la condizione era nel passato prima di un altro evento passato."
            },
            {
                type: "preposition",
                text: "The company specializes ____________ renewable energy solutions.",
                options: ["on", "in", "at", "with"],
                correct: 1,
                explanation: "'Specialize in' Ã¨ la costruzione corretta. Molti verbi hanno preposizioni specifiche: depend on, succeed in, excel at. Queste collocazioni devono essere memorizzate perchÃ© non seguono sempre una logica prevedibile."
            },
            {
                type: "modal",
                text: "You ____________ have told me about the meeting! I missed it completely.",
                options: ["should", "must", "would", "can"],
                correct: 0,
                explanation: "'Should have + past participle' esprime un rimpianto o una critica per qualcosa che non Ã¨ stato fatto nel passato. Ãˆ diverso da 'must have' (deduzione forte) o 'would have' (condizionale passato)."
            },
            {
                type: "passive",
                text: "The new regulations ____________ by the government next month.",
                options: ["will implement", "will be implementing", "will be implemented", "are implementing"],
                correct: 2,
                explanation: "La forma passiva futura 'will be implemented' Ã¨ corretta perchÃ© le regolazioni 'vengono implementate' (azione subita dal soggetto). La struttura Ã¨: will + be + past participle. Il passivo si usa quando il focus Ã¨ sull'azione, non su chi la compie."
            },
            {
                type: "reported-speech",
                text: "She told me that she ____________ to Paris the following week.",
                options: ["will go", "would go", "goes", "is going"],
                correct: 1,
                explanation: "Nel discorso indiretto, 'will' diventa 'would' quando il verbo principale Ã¨ al passato. Questo Ã¨ chiamato 'backshift' o concordanza dei tempi. 'The following week' Ã¨ l'equivalente di 'next week' nel discorso indiretto."
            },
            {
                type: "vocabulary",
                text: "The witness gave a very ____________ account of what happened that night.",
                options: ["detailed", "details", "detailing", "detail"],
                correct: 0,
                explanation: "'Detailed' Ã¨ l'aggettivo che significa 'dettagliato'. Gli aggettivi modificano i sostantivi ('detailed account'). 'Details' Ã¨ il sostantivo plurale, 'detailing' Ã¨ il gerundio, 'detail' Ã¨ il sostantivo singolare o verbo."
            },
            {
                type: "phrasal",
                text: "I can't ____________ with this noise anymore. I need to find a quieter place to work.",
                options: ["put up", "put on", "put off", "put down"],
                correct: 0,
                explanation: "'Put up with' significa 'tollerare' o 'sopportare'. Altri phrasal verbs: 'put on' (indossare), 'put off' (rimandare o disgustare), 'put down' (posare o criticare). I phrasal verbs spesso hanno significati non letterali."
            },
            {
                type: "article",
                text: "She plays ____________ piano beautifully, but she can't play ____________ guitar.",
                options: ["the / the", "a / a", "the / a", "â€” / the"],
                correct: 0,
                explanation: "Gli strumenti musicali richiedono l'articolo 'the' quando si parla di suonarli: 'play the piano', 'play the guitar'. Ãˆ un'eccezione alle regole generali degli articoli e deve essere memorizzata."
            },
            {
                type: "comparative",
                text: "The ____________ you practice, the ____________ you'll become at speaking English.",
                options: ["more / better", "most / best", "more / best", "much / good"],
                correct: 0,
                explanation: "'The more...the better' Ã¨ una struttura comparativa parallela che indica una correlazione proporzionale. Entrambe le parti usano la forma comparativa. La struttura Ã¨: the + comparativo + subject + verb, the + comparativo + subject + verb."
            },
            {
                type: "vocabulary",
                text: "The professor's lecture was so ____________ that half the students fell asleep.",
                options: ["bored", "boring", "bore", "boredom"],
                correct: 1,
                explanation: "'Boring' (participio presente) descrive ciÃ² che causa noia. 'Bored' (participio passato) descrive chi prova noia. Regola generale: -ing per la causa, -ed per l'effetto (interesting/interested, exciting/excited)."
            },
            {
                type: "conjunction",
                text: "____________ it was raining heavily, we decided to go hiking.",
                options: ["Despite", "Although", "However", "In spite"],
                correct: 1,
                explanation: "'Although' Ã¨ una congiunzione seguita da soggetto + verbo. 'Despite' e 'in spite of' sono seguiti da sostantivo/gerundio. 'However' Ã¨ un avverbio che collega frasi, non clausole. La struttura determina la scelta."
            },
            {
                type: "wish",
                text: "I wish I ____________ more attention in my English classes when I was younger.",
                options: ["paid", "had paid", "would pay", "pay"],
                correct: 1,
                explanation: "'Wish + past perfect' esprime un rimpianto per il passato. Si usa per situazioni che non si possono cambiare. 'Wish + past simple' Ã¨ per il presente, 'wish + would' per situazioni future o comportamenti fastidiosi."
            },
            {
                type: "quantifier",
                text: "There is ____________ information available about this topic online.",
                options: ["many", "much", "few", "a few"],
                correct: 1,
                explanation: "'Much' si usa con sostantivi non numerabili ('information', 'water', 'money'). 'Many' Ã¨ per numerabili plurali ('books', 'people'). 'Few/a few' sono per numerabili plurali. La distinzione numerabile/non numerabile Ã¨ fondamentale."
            },
            {
                type: "causative",
                text: "I need to ____________ my laptop repaired before the presentation tomorrow.",
                options: ["make", "have", "let", "get"],
                correct: 3,
                explanation: "'Get something done' Ã¨ una struttura causativa che significa 'far fare qualcosa da qualcun altro'. 'Have something done' Ã¨ simile ma piÃ¹ formale. 'Make' e 'let' non si usano in questa struttura passiva."
            },
            {
                type: "vocabulary",
                text: "The company's profits have ____________ by 30% compared to last year.",
                options: ["raised", "risen", "aroused", "arisen"],
                correct: 1,
                explanation: "'Rise' (intransitivo - risen al participio) significa 'aumentare' da solo. 'Raise' (transitivo) significa 'aumentare qualcosa' e richiede un oggetto. 'Arise' significa 'sorgere/emergere', 'arouse' significa 'suscitare/provocare'."
            }
        ];

        function shuffle(array) {
            const arr = [...array];
            for (let i = arr.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [arr[i], arr[j]] = [arr[j], arr[i]];
            }
            return arr;
        }

        function renderQuestions() {
            const container = document.getElementById('questions-container');
            const shuffled = shuffle(questions);
            
            shuffled.forEach((q, idx) => {
                const card = document.createElement('div');
                card.className = 'card question-card';
                
                let content = `
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">Domanda ${idx + 1} <small class="float-end">${q.type}</small></h5>
                    </div>
                    <div class="card-body">
                `;
                
                if (q.passage) {
                    content += `<div class="reading-passage">${q.passage}</div>`;
                }
                
                content += `
                        <p class="lead">${q.text}</p>
                        <div class="options">
                `;
                
                q.options.forEach((opt, i) => {
                    content += `
                        <div class="option" onclick="checkAnswer(${idx}, ${i})">
                            <strong>${String.fromCharCode(65 + i)}.</strong> ${opt}
                        </div>
                    `;
                });
                
                content += `
                        </div>
                        <div class="explanation" id="exp-${idx}">
                            <strong>ðŸ“š Spiegazione:</strong> ${q.explanation}
                        </div>
                    </div>
                `;
                
                card.innerHTML = content;
                container.appendChild(card);
            });
        }

        function checkAnswer(qIdx, optIdx) {
            const q = shuffle(questions)[qIdx];
            const options = document.querySelectorAll('.question-card')[qIdx].querySelectorAll('.option');
            const explanation = document.getElementById(`exp-${qIdx}`);
            
            options.forEach((opt, i) => {
                opt.classList.add('disabled');
                if (i === q.correct) {
                    opt.classList.add('correct');
                }
            });
            
            if (optIdx !== q.correct) {
                options[optIdx].classList.add('incorrect');
            }
            
            explanation.style.display = 'block';
        }

        renderQuestions();
    </script>
</body>
</html>