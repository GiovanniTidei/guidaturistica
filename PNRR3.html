<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz PNNR3</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { 
            padding: 20px 0; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container { max-width: 1200px; }
        .question-card { 
            margin-bottom: 30px; 
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .option { 
            cursor: pointer; 
            transition: all 0.3s; 
            padding: 15px; 
            border-radius: 10px; 
            margin: 10px 0; 
            border: 3px solid #dee2e6;
            background: white;
        }
        .option:hover:not(.disabled) { 
            background: #f8f9fa; 
            transform: translateX(8px);
            border-color: #667eea;
        }
        .correct { 
            background: #d4edda !important; 
            border-color: #28a745 !important;
            animation: correctPulse 0.5s ease;
        }
        .incorrect { 
            background: #f8d7da !important; 
            border-color: #dc3545 !important;
            animation: shake 0.5s ease;
        }
        @keyframes correctPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }
        .disabled { pointer-events: none; opacity: 0.8; }
        .explanation { 
            margin-top: 20px; 
            padding: 20px; 
            background: linear-gradient(135deg, #e0f7fa 0%, #b2ebf2 100%);
            border-left: 5px solid #00acc1; 
            display: none;
            border-radius: 10px;
            animation: slideDown 0.4s ease;
        }
        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .menu-section { 
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        .region-btn { 
            width: 100%;
            height: 70px; 
            font-size: 1.1rem;
            font-weight: 600;
            border-radius: 12px;
            transition: all 0.3s;
            border: none;
            color: white;
        }
        .region-btn:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }
        .back-btn { 
            margin-bottom: 20px;
            border-radius: 10px;
            padding: 10px 25px;
        }
        .test-section {
            background: white;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        .score-badge {
            font-size: 1.2rem;
            padding: 10px 20px;
            border-radius: 10px;
        }
        .region-colors-1 { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .region-colors-2 { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
        .region-colors-3 { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
        .region-colors-4 { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); }
        .region-colors-5 { background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); }
        .general-test-btn {
            background: linear-gradient(135deg, #f6d365 0%, #fda085 100%);
            font-size: 1.3rem;
            padding: 25px;
            border-radius: 15px;
            font-weight: bold;
            border: none;
            color: white;
            box-shadow: 0 10px 30px rgba(253, 160, 133, 0.4);
        }
        .general-test-btn:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(253, 160, 133, 0.6);
        }
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Menu regioni -->
        <div id="menu" class="menu-section">
            <h1 class="display-4 mb-3 text-center" style="color: #667eea; font-weight: bold;">üáÆüáπ Quiz PNNR3</h1>
            <div class="text-center mb-4">
                <span id="loading-indicator" class="badge bg-info">
                    <span class="loading-spinner"></span> Caricamento dati...
                </span>
                <span id="data-info" class="badge bg-success" style="display: none;"></span>
            </div>
            
            <div class="row g-3 mb-4" id="regions-grid"></div>
            
            <hr class="my-5">
            
            <div class="text-center">
                <button class="btn general-test-btn w-100" onclick="startGeneralTest()" id="general-test-btn" disabled>
                    üéØ TEST GENERALE (Caricamento...)
                </button>
                <button class="btn btn-light mt-3" onclick="location.reload();" title="Ricarica la pagina per leggere i JSON aggiornati">
                  üîÑ Ricarica domande
                </button>
            </div>
        </div>

        <!-- Sezione test -->
        <div id="test-section" class="test-section" style="display: none;">
            <button class="btn btn-secondary back-btn" onclick="backToMenu()">
                ‚Üê Torna al Menu
            </button>
            
            <div class="text-center mb-4">
                <h1 class="display-5 mb-2" id="test-title" style="color: #667eea;"></h1>
                <p class="lead mb-3" id="test-subtitle"></p>
                <div>
                    <span class="badge bg-info score-badge" id="score-badge">Punteggio: 0/0</span>
                </div>
            </div>

            <div id="questions-container"></div>

            <div class="text-center mt-5">
                <button class="btn btn-primary btn-lg" onclick="reloadTest()" style="border-radius: 10px; padding: 12px 40px;">
                    üîÑ Ricarica Test
                </button> <br> <br>
                <button class="btn btn-secondary btn-lg ms-2" onclick="backToMenu()" style="border-radius: 10px; padding: 12px 40px;">
                    üè† Menu Principale
                </button>
            </div>
        </div>
    </div>

    <script>
        let quizData = {};
        let regioni = [
            "Inglese", "Pedagogia", "Psicopedagogia", "Metodologie"
        ];

        let currentRegion = null;
        let currentQuestions = [];
        let score = 0;
        let totalQuestions = 0;
        let isGeneralTest = false;

        // Lista di tutti i file JSON da caricare (rimosso quiz-data.json)
        const jsonFiles = [
            'inglese.json',
            'psicopedagogia.json',
            'metodologie.json',
            'pedagogia.json'
        ];

        // Nuova: mescola opzioni e aggiorna rispostaCorretta per ogni domanda
        function randomizeQuizOptions(data) {
            if (!data || typeof data !== 'object') return data;
            
            function shuffleAnnotated(arr) {
                for (let i = arr.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [arr[i], arr[j]] = [arr[j], arr[i]];
                }
            }
            
            for (const region in data) {
                const list = data[region];
                if (!Array.isArray(list)) continue;
                list.forEach(q => {
                    if (!Array.isArray(q.opzioni) || q.opzioni.length === 0) return;
                    const origCorrect = (typeof q.rispostaCorretta === 'number') ? q.rispostaCorretta : 0;
                    const annotated = q.opzioni.map((opt, idx) => ({ opt, idx }));
                    shuffleAnnotated(annotated);
                    q.opzioni = annotated.map(a => a.opt);
                    const newIdx = annotated.findIndex(a => a.idx === origCorrect);
                    q.rispostaCorretta = newIdx >= 0 ? newIdx : 0;
                });
            }
            return data;
        }

        // Funzione per caricare TUTTI i file JSON
        async function loadAllQuizData() {
            try {
                let allData = {};
                let loadedFiles = 0;

                // Aggiorna l'indicatore di caricamento
                document.getElementById('loading-indicator').innerHTML =
                    `<span class="loading-spinner"></span> Caricamento...`;

                // Carica tutti i file JSON in parallelo
                const promises = jsonFiles.map(async (file, index) => {
                    try {
                        const response = await fetch(file);
                        if (!response.ok) {
                            console.warn(`File ${file} non trovato, salto`);
                            return null;
                        }
                        const data = await response.json();
                        loadedFiles++;

                        // Aggiorna progresso (senza numeri)
                        document.getElementById('loading-indicator').innerHTML =
                            `<span class="loading-spinner"></span> Caricamento...`;

                        return data;
                    } catch (error) {
                        console.warn(`Errore nel caricamento di ${file}:`, error);
                        return null;
                    }
                });

                // Attendi che tutti i file siano caricati
                const results = await Promise.all(promises);

                // Unisci tutti i dati (senza contare/mostrare totali)
                results.forEach((data, index) => {
                    if (data && typeof data === 'object') {
                        for (const region in data) {
                            if (allData[region]) {
                                allData[region] = [...allData[region], ...data[region]];
                            } else {
                                allData[region] = data[region];
                            }
                        }
                        console.log(`File ${jsonFiles[index]} caricato con successo`);
                    }
                });

                quizData = allData;

                // Applica randomizzazione
                quizData = randomizeQuizOptions(quizData);

                // Nascondi indicatore di caricamento (non mostro pi√π totali)
                document.getElementById('loading-indicator').style.display = 'none';
                // Mantengo data-info nascosta (non mostrare contatori)
                const dataInfoEl = document.getElementById('data-info');
                if (dataInfoEl) dataInfoEl.style.display = 'none';

                // Abilita il pulsante del test generale e imposta testo semplice
                const generalBtn = document.getElementById('general-test-btn');
                if (generalBtn) {
                  generalBtn.disabled = false;
                  generalBtn.innerHTML = `üéØ TEST GENERALE`;
                }

                generateRegionButtons();

                console.log(`Caricamento completato: ${loadedFiles}/${jsonFiles.length} file`);

            } catch (error) {
                console.error('Errore nel caricamento dei dati:', error);
                document.getElementById('loading-indicator').innerHTML =
                    '‚ùå Errore nel caricamento. Controlla la console.';
            }
        }

        // Funzione per mescolare un array (Fisher-Yates shuffle)
        function shuffleArray(array) {
            const arr = [...array];
            for (let i = arr.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [arr[i], arr[j]] = [arr[j], arr[i]];
            }
            return arr;
        }

        // Genera i pulsanti delle regioni
        function generateRegionButtons() {
            const grid = document.getElementById('regions-grid');
            grid.innerHTML = '';
            
            // Ordina le regioni per nome
            const regioniOrdinate = [...regioni].sort();
            
            regioniOrdinate.forEach((regione, index) => {
                const col = document.createElement('div');
                col.className = 'col-md-4 col-sm-6';
                
                const colorClass = `region-colors-${(index % 5) + 1}`;
                const regionKey = regione.toLowerCase().replace(/[^a-z]/g, '');
                const isAvailable = quizData[regionKey] !== undefined;
                const numDomande = isAvailable ? quizData[regionKey].length : 0;
                
                col.innerHTML = `
                    <button class="btn region-btn ${colorClass}" 
                            onclick="startTest('${regionKey}')"
                            ${!isAvailable ? 'disabled' : ''}>
                        ${regione}
                        ${!isAvailable ? '<br><small>(Prossimamente)</small>' : `<br><small>(${numDomande} domande)</small>`}
                    </button>
                `;
                grid.appendChild(col);
            });
        }

        function startTest(regionKey) {
            if (!quizData[regionKey]) {
                alert('Quiz non ancora disponibile per questa regione');
                return;
            }

            isGeneralTest = false;
            currentRegion = regionKey;
            
            // Mescola le domande in ordine casuale
            currentQuestions = shuffleArray(quizData[regionKey]);
            score = 0;
            totalQuestions = currentQuestions.length;

            document.getElementById('menu').style.display = 'none';
            document.getElementById('test-section').style.display = 'block';
            
            const regionName = regioni.find(r => r.toLowerCase().replace(/[^a-z]/g, '') === regionKey);
            document.getElementById('test-title').textContent = `Quiz: ${regionName}`;
            document.getElementById('test-subtitle').textContent = `${totalQuestions} domande sui tesori turistici della regione`;
            updateScore();
            
            renderQuestions();
            window.scrollTo(0, 0);
        }

        function startGeneralTest() {
            isGeneralTest = true;
            currentRegion = 'generale';

            // mappa: file/chiave -> numero di quesiti richiesti
            // Aggiornato per ottenere 50 domande totali: inglese 10, pedagogia 10, psicopedagogia 15, metodologie 15
            const desired = {
                'inglese': 10,
                'pedagogia': 10,
                'psicopedagogia': 15,
                'metodologie': 15
            };
            const targetTotal = Object.values(desired).reduce((a,b)=>a+b,0);

            // raccoglie campioni per ciascuna chiave
            let selected = [];
            for (const key in desired) {
                const pool = Array.isArray(quizData[key]) ? quizData[key].slice() : [];
                if (pool.length === 0) continue;
                const sample = shuffleArray(pool).slice(0, desired[key]).map(q => ({ ...q, region: key }));
                selected = selected.concat(sample);
            }

            // se mancano domande, riempi con elementi disponibili da tutte le regioni (evita duplicati per 'domanda')
            if (selected.length < targetTotal) {
                let pool = [];
                for (const r in quizData) {
                    if (Array.isArray(quizData[r])) {
                        pool = pool.concat(quizData[r].map(q => ({ ...q, region: r })));
                    }
                }
                const existing = new Set(selected.map(q => q.domanda));
                const remaining = pool.filter(q => !existing.has(q.domanda));
                selected = selected.concat(shuffleArray(remaining).slice(0, targetTotal - selected.length));
            }

            if (selected.length === 0) {
                alert('Non ci sono domande disponibili al momento');
                return;
            }

            // mescola l'insieme finale e imposta il test
            selected = shuffleArray(selected);
            currentQuestions = selected;
            score = 0;
            totalQuestions = currentQuestions.length;

            document.getElementById('menu').style.display = 'none';
            document.getElementById('test-section').style.display = 'block';

            document.getElementById('test-title').textContent = 'üéØ Test PNRR3';
            // sottotitolo semplificato: solo numero di domande
            document.getElementById('test-subtitle').textContent = `${totalQuestions} domande`;
            updateScore();

            renderQuestions();
            window.scrollTo(0, 0);
        }

        function renderQuestions() {
            const container = document.getElementById('questions-container');
            container.innerHTML = '';
            
            currentQuestions.forEach((q, idx) => {
                const card = document.createElement('div');
                card.className = 'card question-card';
                
                let regionBadge = '';
                if (isGeneralTest && q.region) {
                    const regionName = regioni.find(r => r.toLowerCase().replace(/[^a-z]/g, '') === q.region);
                    regionBadge = `<span class="badge bg-secondary float-end">${regionName}</span>`;
                }
                
                let content = `
                    <div class="card-header bg-primary text-white" style="border-radius: 15px 15px 0 0;">
                        <h5 class="mb-0">‚ùì Domanda ${idx + 1} di ${totalQuestions} ${regionBadge}</h5>
                    </div>
                    <div class="card-body">
                        <p class="lead fw-bold">${q.domanda}</p>
                        <div class="options">
                `;
                
                q.opzioni.forEach((opt, i) => {
                    content += `
                        <div class="option" onclick="checkAnswer(${idx}, ${i})">
                            <strong>${String.fromCharCode(65 + i)}.</strong> ${opt}
                        </div>
                    `;
                });
                
                content += `
                        </div>
                        <div class="explanation" id="exp-${idx}">
                            <strong>üí° Spiegazione:</strong><br>${q.spiegazione}
                        </div>
                    </div>
                `;
                
                card.innerHTML = content;
                container.appendChild(card);
            });
        }

        function checkAnswer(qIdx, optIdx) {
            const q = currentQuestions[qIdx];
            const questionCard = document.querySelectorAll('.question-card')[qIdx];
            const options = questionCard.querySelectorAll('.option');
            const explanation = document.getElementById(`exp-${qIdx}`);
            
            // Controlla se gi√† risposto
            if (options[0].classList.contains('disabled')) {
                return;
            }

            options.forEach((opt, i) => {
                opt.classList.add('disabled');
                if (i === q.rispostaCorretta) {
                    opt.classList.add('correct');
                    opt.innerHTML += ' ‚úì';
                }
            });
            
            if (optIdx !== q.rispostaCorretta) {
                options[optIdx].classList.add('incorrect');
                options[optIdx].innerHTML += ' ‚úó';
            } else {
                score++;
                updateScore();
            }
            
            explanation.style.display = 'block';
        }

        function updateScore() {
            const badge = document.getElementById('score-badge');
            badge.textContent = `Punteggio: ${score}/${totalQuestions}`;
            
            if (score === totalQuestions && totalQuestions > 0) {
                badge.className = 'badge bg-success score-badge';
            } else if (score > totalQuestions / 2) {
                badge.className = 'badge bg-warning score-badge';
            } else {
                badge.className = 'badge bg-info score-badge';
            }
        }

        function backToMenu() {
            document.getElementById('test-section').style.display = 'none';
            document.getElementById('menu').style.display = 'block';
            currentRegion = null;
            isGeneralTest = false;
        }

        function reloadTest() {
            if (isGeneralTest) {
                startGeneralTest();
            } else if (currentRegion) {
                startTest(currentRegion);
            }
        }

        // Carica tutti i dati all'avvio
        loadAllQuizData();
    </script>
</body>
</html>